{"title":"Batch Reports","content":"## Batch Reports\n\nThe *Batch Reports* endpoint requires you to specify a JSON Query, which must be an instance of the Google Analytics API's **[ReportRequest](https://developers.google.com/analytics/devguides/reporting/core/v4/rest/v4/reports/batchGet#ReportRequest)** class.\n\nPlease refer to the [official documentation](https://developers.google.com/analytics/devguides/reporting/core/v4/rest/v4/reports/batchGet) for details on how to compose a ReportRequest query.\n\nA valid query might look something like this:\n\n```json\n  {\n    \"viewId\":\"XXXXXXXXX\",\n    \"dateRanges\":[\n      {\n        \"startDate\":\"2018-07-30\",\n        \"endDate\":\"2018-07-31\"\n      }\n    ],\n    \"metrics\":[\n      {\"expression\":\"ga:users\"},\n      {\"expression\":\"ga:sessions\"},\n      {\"expression\":\"ga:hits\"}\n    ],\n    \"dimensions\":[\n      {\"name\":\"ga:date\"},\n      {\"name\":\"ga:city\"},\n      {\"name\":\"ga:browser\"}\n    ]\n  }\n```\n\nYou can interpolate variables into your Query through the hibase syntax, for example:\n\n```json\n  {\n    // ...\n    \"dateRanges\":[\n      {\n        \"startDate\":\"{{ $today - 7 }}\",\n        \"endDate\":\"{{ $today }}\"\n      }\n    ],\n    // ...\n  }\n```\n\n### Response normalization\n\nhibase takes care of normalizing the data coming back from the Google Analytics Reporting API, in order to represent it in a two-dimensional, tabular format.\n\nProvided this response originating from the API call...\n\n```json\n  {\n    \"reports\": [\n      {\n        \"columnHeader\": {\n          \"dimensions\": [\n            \"ga:date\",\n            \"ga:city\",\n            \"ga:browser\"\n          ],\n          \"metricHeader\": {\n            \"metricHeaderEntries\": [\n              {\n                \"name\": \"ga:users\",\n                \"type\": \"INTEGER\"\n              },\n              {\n                \"name\": \"ga:sessions\",\n                \"type\": \"INTEGER\"\n              },\n              {\n                \"name\": \"ga:hits\",\n                \"type\": \"INTEGER\"\n              }\n            ]\n          }\n        },\n        \"data\": {\n          \"rows\": [\n            {\n              \"dimensions\": [\n                \"20180727\",\n                \"Berlin\",\n                \"Chrome\"\n              ],\n              \"metrics\": [\n                {\n                  \"values\": [\n                    \"42\",\n                    \"56\",\n                    \"322\"\n                  ]\n                }\n              ]\n            },\n            {\n              \"dimensions\": [\n                \"20180728\",\n                \"Berlin\",\n                \"Chrome\"\n              ],\n              \"metrics\": [\n                {\n                  \"values\": [\n                    \"44\",\n                    \"62\",\n                    \"398\"\n                  ]\n                }\n              ]\n            },\n            // ...\n          ]\n        }\n      }\n    ]\n  }\n```\n\n... hibase will parse it and serve it as follows:\n\n```json\n  {\n    \"headers\": [\n      {\n        \"name\": \"ga_date\",\n        \"type\": \"string\"\n      },\n      {\n        \"name\": \"ga_city\",\n        \"type\": \"string\"\n      },\n      {\n        \"name\": \"ga_browser\",\n        \"type\": \"string\"\n      },\n      {\n        \"name\": \"ga_users\",\n        \"type\": \"integer\"\n      },\n      {\n        \"name\": \"ga_sessions\",\n        \"type\": \"integer\"\n      },\n      {\n        \"name\": \"ga_hits\",\n        \"type\": \"integer\"\n      }\n    ],\n    \"data\": [\n      [\n        \"20180727\",\n        \"Berlin\",\n        \"Chrome\",\n        \"42\",\n        \"56\",\n        \"322\"\n      ],\n      [\n        \"20180728\",\n        \"Berlin\",\n        \"Chrome\",\n        \"44\",\n        \"62\",\n        \"398\"\n      ],\n      // ...\n    ]\n  }\n```\n\nAs you can see, a few things are happening here:\n\n- Colons within header names are being changed to underscores, in order to be valid as column names for a possible SQL insert: e.g. `ga:users` becomes `ga_users`\n- Header *data types* are being inferred from the response\n- Data from different paths within the JSON is being aggregated into one-dimensional rows: \n```json\n  [\n    \"20180727\",\n    \"Berlin\",\n    \"Chrome\",\n    \"42\",\n    \"56\",\n    \"322\"\n  ]\n```\n\n\n### Pagination\n\nThe Google Analytics Reporting API is paginated through the `pageToken` and `pageSize` parameters, as outlined in the [official docs](https://developers.google.com/analytics/devguides/reporting/core/v4/rest/v4/reports/batchGet). \n\nhibase takes care of automatically iterating requests if a `nextPageToken` is received from the API. If given no other instruction, it will do so until an empty data set is returned or the `nextPageToken` parameter is not returned anymore. \n\n> **NB**: Limits apply to how many subsequent calls can be made through automatic pagination. Please get in touch in case you are reaching your limits and you would like them to be increased. \n\nYou can still take back control of the API call and retrieve a specific set of records by manually providing a `pageToken` parameter in your `query`. In this case, hibase will not iterate any further regardless of what `nextPageToken` is returned by the API."}
